---
title: "Дисперсионный анализ в R"
author: "Lulin Dmitry"
date: "2024-12-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Раздел 3. Дисперсионный анализ (ANOVA)

### 1.1. Однофакторный дисперсионный анализ (One-Way ANOVA)

#### 1.1.1. Основные понятия
В начале традиционно импортируем данные для последующей работы. В это раз для чтения файла Excel воспользуемся библиотекой `readxl`.
```{r}
library(readxl)
data = read_excel('demo_data.xlsx')
print(data)
```
```{r}
meanarea = tapply(data$quantity, data$area, mean)
meanarea
```
Как видно, данные были сгруппированы по 4 значениям, то есть по районам города, и операция mean, то есть вычисление
среднего арифметического, была применена к каждой группе. В результате мы
получили 4 значения доли учеников с золотой медалью.

Далее мы применим ту же операцию вычисления среднего к долям школьников, но теперь группировка будет идти по типу школы. Выполняем
аналогичную операцию, и выводим соответствующие значения. 
```{r}
meanschool = tapply(data$quantity, data$school, mean)
meanschool
```
#### 1.1.2. Графическое представление различий между средними изучаемых групп
построим два графика, которые также сгруппируют нам доли школьников с золотой медалью
по соответствующим уровням факторов, отдельно для районом и отдельно
для типов школ. Первая группировка у нас будет идти по району. Наша
формула – это доля школьников с золотой медалью в зависимости от района, взятые из
нашего набора данных. Посмотрим, что даст соответствующая операция
`stripchart`.

```{r, fig.cap= "*Рис.9. Точечный график зависимости доли школьников с золотой медалью от района (построен с помощью встроенной функции `stripchart`)*"}
stripchart(quantity ~ area, data=data, col='magenta', ylab='Education',
xlab='quantity', main='area')
```
На графике (рис. 9) у нас по оси X откладываются доли школьников, по оси Y — уровни фактора, от первого до четвертого. В результате снизу вверх видим уровни количества золотых медалей в зависимости от района (1,2,3,4). Если внимательно присмотреться к этому графику (рис. 9), можно заметить некоторую тенденцию, что в среднем значения количества золотых медалей разное в зависимости от района, однозначного вывода о связи района с количеством золотых медалей сделать нельзя. 

Аналогичную картину мы построим для разных типов школ.
```{r, fig.cap= "*Рис.10. Точечный график зависимости доли школьников с золотой медалью от типа школы (построен с помощью встроенной функции `stripchart`)*"}
stripchart(quantity ~ school, data=data, col='blue', ylab='Experience',
xlab='quantity', main='school')
```
На рис. 10 мы получили похожий график, на котором по оси X доли школьников, а по Y – категории второго фактора. То есть имеем долю школьников для обычной школы, с углубленным изучением английского языка и физико-математической. Графически здесь также
наблюдается явное отличие средних, но это требует более строгой проверки.

По следующему графику мы также можем наблюдать
выраженную тенденцию возрастания (или неубывания) доли школьников с золотой медалью по мере изменения района города. 
```{r, fig.cap= "*Рис.11. Точечный график зависимости средней доли школьников с золотой медалью от района (построен с помощью встроенной функции `plot`)*"}
plot(meanarea, type='o', col='magenta', xlab='area', ylab='quantity')
```
Построим аналогичный график для типов школ (рис. 12). Также строим его
точками, соединенными линиями, цвет выбираем голубой, подписываем оси. 
```{r, fig.cap= "*Рис.12. Точечный график зависимости средней доли школьников с золотой медалью от типа школы (построен с помощью встроенной функции `plot`)*"}
plot(meanschool, type='o', col='blue', xlab='school', ylab='quantity')
```
Судя по данному графику (рис. 12) также видно, что для более сильных школ характернее иметь много медалистов, но нам необходимо проверить, является ли данное
отличие статистически значимым. На этот вопрос нам поможет ответить
дисперсионный анализ, который мы проведем чуть позже.

Box-and-whisker plot – дословно «ящик с усами» - вид графика, который
позволяет увидеть и размах данных, их асимметрию, и наличие выбросов и
экстремальных значений в выборке (рис. 13).
```{r, fig.cap= "*Рис.13. Ящичковая диаграмма (box plot) средней доли школьников с золотой медалью от района (построена с помощью встроенной функции `boxplot`)*"}
boxplot(quantity ~ area, data=data, ylab='quantity', col='magenta')
```
Видим, что средние в зависимости от районов отличаются, а сами ящики или интеркварильный размахи находятся на разных уровнях. В дальнейшем проверим существенность этих различий.

Проделаем то же самое для типов школ.
```{r, fig.cap= "*Рис.14. Ящичковая диаграмма (box plot) средней доли школьников с золотой медалью от типа школы (построена с помощью встроенной функции `boxplot`)*"}
boxplot(quantity ~ school, data=data, ylab='quantity', col='magenta')
```
Здесь различия в средних меньше, а размахи существенно пересекаются у обычной и языковой школы.

Построим скрипичную диаграмму для наших данных. Сначала подключим
пакет `ggplot2`:
```{r}
library('ggplot2')
```
Установим категориальный (факторный) тип переменной area (район) и зададим скрипичный график. 
```{r, fig.cap="*Рис. 15. Скрипичная диаграмма (violin plot) количества золотых медалистов в зависимости от района*"}
data$area <- as.factor(data$area)
p <- ggplot(data, aes(x=area, y=quantity, fill= area)) + geom_violin(trim=FALSE)
p
```
Также можем повернуть этот график на 90 градусов.
```{r, fig.cap="*Рис. 16. Скрипичная диаграмма (violin plot) количества золотых медалистов в зависимости от района*"}
p + coord_flip()
```
Теперь на скрипичную диаграмму наложим ящик с усами.
```{r, fig.cap="*Рис. 17. Скрипичная и ящичковая диаграммы (слева) или диаграмма рассеяния (справа) доли школьников с золотыми медалями в зависимости от района*"}
p + geom_boxplot(width=0.2)
```
Удобной может оказаться также функция наложения скрипичной
диаграммы и диаграммы рассеяния.
```{r, fig.cap="*Рис. 18. Скрипичная диаграмма и диаграмма рассеивания доли школьников с золотыми медалями в зависимости от района*"}
p + geom_dotplot(binaxis='y', stackdir='center', dotsize=1)
```
#### 1.1.3.Проведение однофакторного дисперсионного анализа в R

Перейдем непосредственно к дисперсионному анализу. Построим график квантиль - квантиль.
```{r, fig.cap="*Рис. 19. График квантиль-квантиль доли медалистов и нормального распределения (построен с помощью функции `qqPlot` пакета `car`)*"}
library("car")
qqPlot(data$quantity)
```
Как видим, сопоставимость относительно высока,  большая часть наблюдаемых значений находится рядом с прямой равенства эмпирических и теоретических квантилей, поэтому можем предположить, что доля медалистов может подчиняться нормальному распределению.

Теперь формально проверим, что наша выборка действительно
подчиняется нормальному распределению. Переменной, используемой для
проведения дисперсионного анализа, в данном случае является количество медалистов, именно
для нее мы проверим гипотезу о нормальности.

Применим критерий Шапиро-Уилка, наиболее подходящий для малых выборок.
```{r}
shapiro.test(data$quantity)
```
Как видим, значение $p-value = 0.6159$ больше заданного в 5% уровня
значимости, значит, нулевая гипотеза о соответствии
зависимой переменной нормальному распределению в нашем случае не
отвергается, следовательно, мы можем применять дисперсионный анализ. 

Теперь проверим вторую предпосылку применения ДА – однородность
дисперсий между уровнями каждого фактора с помощью теста Левене – используем функцию `leveneTest` из пакета `car`.

Проверим тип наших переменных и получим, что первая переменная – числовая, вторая – текстовая:
```{r}
str(data$area)
str(data$school)
```
Перед проведением теста надо снова превратить наши переменные
в факторные.
```{r}
data$area <- factor(data$area)
str(data$area)
```
Теперь можно провести тест Левене с медианами по умолчанию .
```{r}
leveneTest(data$quantity, data$area)
```
```{r}
leveneTest(data$quantity, data$area, center=mean)
```
В обоих случаях $p-value$ больше любого разумного уровня значимости,
поэтому нулевая гипотеза об однородности дисперсий между группами фактора
образования не отвергается.

И то же самое проводим с фактором типов школ.
```{r}
data$school <- factor(data$school)
str(data$school)
```
```{r}
leveneTest(data$quantity, data$school)
```
```{r}
leveneTest(data$quantity, data$school, center=mean)
```
В обоих случаях $p-value$ больше любого разумного уровня
значимости, поэтому нулевая гипотеза об однородности дисперсий между
группами фактора стажа также не отвергается.

Итак, все предпосылки применения дисперсионного анализа проверили,
можно приступать к самому анализу.

Для начала мы проверим гипотезу о том, что доли медалистов
равны в среднем по всем районам выборки. Для этого выполним
дисперсионный анализ и сразу выведем результаты.

Нулевая гипотеза, проверяемая в дисперсионном анализе – что средние всех
уровней фактора равны (фактор не влияет на зависимую переменную 𝑌). 
```{r}
summary(aov(data$quantity ~ data$area))
```
В данном случае мы должны посмотреть на значение $p-value = 0.127$,
которое у нас указывается в соответствующей строке, и в данном случае оно
больше, чем 0.05 – заданный уровень значимости. Соответственно, с вероятностью
ошибки $𝛼$ = 0.05 мы нулевую гипотезу не отвергаем, т.е. на уровне значимости $𝛼$ = 0.05 мы можем признать, что влияние данного фактора статистически не значимо. 

Проведём аналогичный анализ для второй переменной типов школ. Это будет
тоже однофакторный дисперсионный анализ без рассмотрения другого фактора. 
```{r}
summary(aov(data$quantity ~ data$school))
```
Здесь также проверяется гипотеза о том, что средние равны, значение $p-value$ у нас получилось больше, чем 0.01.

Соответственно, гипотеза о равенстве средних по уровням данного фактора у нас
не отвергается на уровне значимости $𝛼$ = 0.01. Следовательно, можно сделать
вывод о том, что тип школы не влияет на размер заработной платы или по
данной выборке (очень небольшого объема) влияние фактора не доказано.

### 1.2. Двухфакторный ДА (Two-Way ANOVA)

Наконец, проведём двухфакторный дисперсионный анализ, когда в
рассмотрение будут включены оба фактора.

#### 1.2.1. Без учета взаимодействия факторов (n=1)

Поскольку в исходной таблице было по одному наблюдению в каждой
ячейке, мы не можем рассматривать эффект взаимодействия факторов. То есть
просто добавляем теперь влияние двух факторов в нашу модель.
```{r}
summary(aov(data$quantity ~ data$area + data$school))
```

Здесь дисперсии немного перераспределились, как раз-таки по двум предположительно влияющим факторам. У нас часть дисперсии объясняется фактором района, часть дисперсии объясняется влиянием школы, и также, естественно, присутствует остаточная дисперсия. В последнем столбце мы видим значение p−value для проверки гипотез о равенстве средних по всем уровням соответствующего фактора. И для района ($p−value=0.075$), и для школы ($p−value=0,125$) это значение существенно больше 0.05 и 0,01 соответственно, следовательно с достаточно высокой статистической значимостью мы не отвергаем гипотезы о равенстве средних по обоим факторам и выносим решение об их несущественном влиянии на количество медалистов.
#### 1.2.2. Проверка равенства средних выбранных уровней (post hoc tests) – тест Тьюки

Проведем тест Тьюки TukeyHSD для сравнения средней заработной платы между различными уровнями образования:
```{r}
anova_data <- aov(data$quantity ~ data$area)
summary(anova_data)
TukeyHSD(anova_data)
```
Результат проведения теста Тьюки приведён в нижней части кода: в первом столбце содержатся номера сравниваемых групп, во втором — оценка разницы в уровнях, в третьем и четвёртом — нижняя и верхняя границы 95%-го доверительного интервала, а последний столбец содержит в себе $p−value$.

Как можно видеть для всех групп доверительный интервал содержит ноль, а $p−value$
значительно превышает 0.05, вследствие чего нулевая гипотеза о равенстве средних не отвергается на заданном уровне значимости. Этот вывод подтверждается результатами проверки основной гипотезы ДА, представленными в верхней части кода $p−value(F_{набл.})=0,127>α=0.05$ , вследствие чего нулевая гипотеза о равенстве средних выбранных уровней не отвергается с вероятностью ошибки α=0.05. Теперь можем визуализировать полученные результаты теста, построив 95-процентные доверительные интервалы для всех уровней:
```{r, fig.cap= "*Рис. 20. Доверительные интервалы с надежностью 0,95 для разницы средних выборных уровней количества медалистов*"}
tukey <- TukeyHSD(anova_data)
plot(tukey)
```
Эта визуализация подтверждает полученные выше результаты - как можно видеть, для всех групп доверительный интервал содержит 0, вследствие чего нулевая гипотеза о равенстве средних не отвергается на заданном уровне значимости (левая граница доверительного интервала – отрицательна, правая положительна).

Проведем тот же тест для сравнения доли медалистов между различными типами школ:
```{r}
anova_data_new <- aov(data$quantity ~ data$area) 
summary(anova_data_new)
TukeyHSD(anova_data_new)
```
Как можно заметить, для всех групп доверительный интервал содержит ноль, а $p−value$ больше 0.01, вследствие чего нулевая гипотеза о равенстве средних не отвергается на заданном уровне значимости. Этот вывод подтверждается результатами проверки основной гипотезы ДА, представленными в верхней части кода $p−value(F_{набл.})=0,267>α=0.01$, вследствие чего нулевая гипотеза о равенстве средних выбранных уровней не отвергается с вероятностью ошибки $α$=0.01. Теперь можем визуализировать полученные результаты теста, построив 95-процентные доверительные интервалы для всех уровней:
```{r, fig.cap="*Рис. 21. Доверительные интервалы с надежностью 0,95 для разницы средних выборных уровней школ*"}
tukey <- TukeyHSD(anova_data_new) 
plot(tukey)
```
Эта визуализация подтверждает полученные выше результаты - как можно видеть, для всех групп доверительный интервал содержит 0, вследствие чего нулевая гипотеза о равенстве средних не отвергается на заданном уровне значимости.

